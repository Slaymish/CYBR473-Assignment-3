#include "utils.h"
#include "config.hpp"
#include <windows.h>
#include <string>
#include <sstream>

using namespace std;

// String deobfuscation
string deobfuscate(const char* obf_str) {
    string result;
    for (int i = 0; obf_str[i] != 0; i++) {
        result += (obf_str[i] ^ 0x42);
    }
    return result;
}

string generate_client_id() {
    // Generate client ID
    string client_id;
    HKEY hKey;
    if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, 
                        "SOFTWARE\\Microsoft\\Cryptography", 
                        0, KEY_READ, &hKey) == ERROR_SUCCESS) {
        char guid[256] = {0};
        DWORD guidSize = sizeof(guid);
        DWORD type;
        
        if (RegQueryValueExA(hKey, "MachineGuid", NULL, &type, 
                            (BYTE*)guid, &guidSize) == ERROR_SUCCESS) {
            client_id = string(guid);
        } else {
            client_id = "unknown";
        }
        RegCloseKey(hKey);
    } else {
        client_id = "unknown";
    }
    
    // if machine specs are not available, generate a unique ID (based on tick count)
    if (client_id == "unknown") {
        stringstream ss;
        ss << "client_" << GetTickCount();
        client_id = ss.str();
    }

    return client_id;
}